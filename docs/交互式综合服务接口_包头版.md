交互式综合服务接口设计说明
==========================

(The Description of Interactive Integrated Services Interface)

-	所有接口采用 HTTP 协议 post 方式请求, 地址格式为`http://ip:port/interface_name`  
-	所有请求以及返回中的时间字段均采用Linux时间戳格式,精确到秒,int64类型
-	提交的参数和返回数据格式为 Google Protocol Buffer ( protobuf ) 协议序列化后再经由 base64 编码得到的字符串  
-	protobuf 协议格式说明  
	> 协议采用 proto3 格式编写,使用 protoc v3.0 beta2 编译  
	> 所有时间字段，均采用unix秒格式

> 该头结构将插入每个请求或返回的协议结构体中  
> 协议类名加前缀 "rq" 表示客户端->服务端,无前缀表示服务端->客户端

```protobuf
message Head {
    int64 idx = 1;  // 序号(必填)
    int32 ver = 2;  // 协议版本(必填,默认为协议发布日期6位整型)。当前版本为 160328
    string if_name = 3;  // 接口名称(可选)
    int64 if_dt = 100;  // 请求或返回时间(必填)
    int32 if_st = 101;  // 接口操作状态(返回必填)
                            // 1-操作成功, 0-操作失败, 原因参考msg, 10-用户未登录或超时(0.5h),请求被拒绝, 11-用户权限不足,12-用户登录ip非法,需重新登录
                            // 41-数据库连接失败,42-指令提交失败(socket pool),43-第三方接口调用失败,45-数据库提交失败,46-参数错误,
			    // 99-接口参数暂不支持
    string if_msg = 102;  // 失败时填充详细原因(可选)
    repeated string msg_filter = 103;  // 调用接口后可能产生的消息过滤器，仅对设备操作类型接口有效，如终端开关灯、选测，客户端可以动态设置这些过滤器用来获得精准推送
    int32 paging_num = 200;  // 此次请求/应答是否使用分页(仅对非参数数据查询类接口有效,'query'开头的接口),0-不使用,大于0时使用,但是,若客户端请求的赋值>100或数据总量大于100,服务端按照100进行强制分页
    int32 paging_idx = 201;  // 分页序号,从1开始,当序号大于分页总数时返回空
    int32 paging_total = 202;  // 服务端返回该次请求产生的分页总数(客户端请求数据时不填充)
    int64 paging_buffer_tag = 203;  // 分页缓存标签,0-要求服务器重建缓存,xx-根据服务器返回的tag从对应缓存读取数据
    int32 paging_record_total = 204;  // 查询记录总数
}
```

-	公共应答  
	> 公共应答仅包含head信息，用于不需要添加附加数据的场合

```
message CommAns {
    Head head = 1;  // 协议头信息
}
```

版本 v160328:
-------------

### 用户/区域类

> 所有用户均包含隐含属性:客户代码,即系统终端和服务器的通信端口号,当管理员创建新用户时,新用户自动继承该属性,所有操作也默认从uuid中获取该属性作为必要条件  
> 用户权限:  
> > 1-X(可操作)  
> > 2-W(可设置)  
> > 4-R(可查询)  
> > 3-XW(可操作,可设置)  
> > 5-RX(可查询,可操作)  
> > 6-RW(可设置,可查询)  
> > 7-RWX(可查询,可设置,可操作)  
> > 15-DRWX(管理员)

---

#### 用户验证

> 接口名称: userlogin  
> 对登录用户的用户名和密码进行验证,验证成功返回uuid,有效期默认30分钟  
> 使用获得的uuid访问任意接口即可重置有效期  
> 若登录后ip发生变化,则认为是非法登录,会注销当前用户

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserLogin {
    Head head = 1;  // 协议头信息
    int32 dev = 2;  // 设备类型,1-pc,2-web,3-移动设备,不同设备同一用户可同时登录,同种设备同一用户互斥
    string unique = 3;  // 移动设备唯一标示(移动设备填充,可以由服务器配置文件设置是否校验)
    string user = 4;  // 用户名
    string pwd = 5;  // 密码
    double lon = 6; // 登录设备经度(选填)
    double lat = 7;  // 登录设备纬度(选填)
}
```

返回:

```protobuf
message UserLogin {
    Head head = 1;  // 协议头信息
    string uuid = 2;  // 用户验证成功后分配的uuid(系统生成)
    int32 auth = 3;  // 用户权限值
    string fullname = 4;  // 用户全名
    string user_db = 5;  // 用户关联数据库名称
    int32 user_area = 6;  // 用户的区域id(暂不用)
    string zmq = 7;  // 信息推送服务地址(zmp端口号)
    string remark = 8; // 备注信息,如工作流系统登录的返回信息
    repeated int32 area_r = 9 [packed=true];  // 可读区域
    repeated int32 area_w = 10 [packed=true];  // 可写区域
    repeated int32 area_x = 11 [packed=true];  // 可操作区域
}
```

---

#### 用户注销

> 接口名称: userlogout  
> 用户退出登录,注销uuid

参数:  
1. uuid - 用户uuid

返回:  
CommAns应答

---

#### 用户uuid续订

> 接口名称: userrenew  
> 用户续订当前uuid,续订后有效期为续订成功开始30分钟

参数:  
1. uuid - 用户当前uuid  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqUserRenew {
    Head head = 1;
    int32 dev = 2;  // 设备类型,1-pc,2-web,3-移动设备
    string unique = 3;  // 移动设备唯一标示(移动设备填充)
}
```

返回: CommAns应答

---

### 设备信息类

> 设备信息以模块为节点,与模块直接通信的设备均为主设备,下挂在模块下,通过终端485通信的设备或各类末端为附属设备

#### 主设备基础信息返回

> 接口名称: tmlinfo  
> 获取各类设备的基本参数以及工作参数

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqTmlInfo {
    Head head = 1;
    repeated int32 data_mark = 5 [packed=true];  // 请求数种类,9-mruinfo
    repeated int32 tml_id = 6 [packed=true];  // 请求的设备逻辑id, 留空-返回所有数据
}
```

返回:

```protobuf
message TmlInfo {
    message MruInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        repeated int32 mru_id = 2 [packed=true];  // 抄表地址,六字节
        int32 mru_baud_rate = 3;  // 波特率
        int32 mru_transformer = 4;  // 电表变比
        int32 mru_type = 5;  // 协议版本,1-1997,2-2007
    }
    Head head = 1;
    repeated BaseInfo base_info = 12;  // 设备基础信息
    repeated MruInfo mru_info = 19;  // 抄表设备填充
    repeated int32 data_mark = 3 [packed=true];  // 请求数种类,9-mruinfo
}
```

---

### 设备信息类

> 设备信息以模块为节点,与模块直接通信的设备均为主设备,下挂在模块下,通过终端485通信的设备或各类末端为附属设备,下挂在对应设备下 tml-泛指各类设备,rtu-路灯终端,als-光照度,slu-单灯,ldu-防盗,mru-抄表,esu-节能,com-模块

#### 主设备基础信息返回

> 接口名称: tmlinfo  
> 获取各类设备的基本参数以及工作参数

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqTmlInfo {
    Head head = 1;
    repeated int32 data_mark = 5 [packed=true];  // 请求种类 9-mruinfo
    repeated int32 tml_id = 6 [packed=true];  // 请求的设备逻辑id, 留空-返回所有数据
}
```

返回:

```protobuf
message TmlInfo {
    message MruInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        repeated int32 mru_id = 2 [packed=true];  // 抄表地址,六字节
        int32 mru_baud_rate = 3;  // 波特率
        int32 mru_transformer = 4;  // 电表变比
        int32 mru_type = 5;  // 协议版本,1-1997,2-2007
    }
    Head head = 1;
    repeated MruInfo mru_info = 19;  // 抄表设备填充
    repeated int32 data_mark = 3 [packed=true];  // 请求种类 9-mruinfo
}
```

---

### 电表类

#### 电表数据查询

> 接口名称: querydatamru  
> 查询电表数据

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataMru {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要查询的电表设备逻辑地址列表,留空表示查询所有设备
    int64 dt_start = 3;  // 查询起始日期
    int64 dt_end = 4;  // 查询结束日期, 若dt_start,dt_end 均为0,则表示查询最新一条数据
}
```

返回:

```protobuf
message QueryDataMru {
    message MruData {
        int64 dt_create = 1;  // 数据接收日期
        int32 tml_id = 2;  // 设备逻辑地址
        int32 data_mark = 3;  // 抄表类型,1-A相，2-B相，3-C相，4-总电量
        int32 dt_mark = 4;  // 抄表时间段,0-当前，1-上月，2-上上月
        double mru_value = 5;  // 抄表值
    }
    Head head = 1;
    repeated MruData mru_data = 3;
}
```

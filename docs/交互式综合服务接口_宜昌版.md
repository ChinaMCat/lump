<div style="text-align:center; font-size:1cm; font-family:WenQuanYi Micro Hei;">交互式综合服务接口设计说明</div>

<div style="text-align:center; font-size:0.6cm; font-family:WenQuanYi Micro Hei;">(The Description of Interactive Integrated Services Interface)</div>
<div style="text-align:center; font-size:0.6cm; font-family:WenQuanYi Micro Hei;">(宜昌路灯用)</div>

<br/>

<!-- toc orderedList:0 depthFrom:1 depthTo:6 -->

-	[2 基础信息类](#2-基础信息类)
	-	[2.7 主设备基础信息返回](#27-主设备基础信息返回)
-	[4. 数据查询类](#4-数据查询类)
	-	[4.1 终端数据查询](#41-终端数据查询)

<!-- tocstop -->

-	所有接口采用 HTTP 协议 post 方式请求, 地址格式为`http://ip:port/interface_name`  
-	提交的参数和返回数据格式为 Google Protocol Buffer ( protobuf ) 协议序列化后再经由 base64 编码得到的字符串  
-	所有请求以及返回中的时间字段均采用Linux时间戳格式,精确到秒,int64类型
-	对于设备应答消息以及需要即时转发的指令，采用zeroMQ(缩写zmq)推送，目前暂定服务端采用PUB方式广播推送，客户端采用SUB方式接收

-	protobuf 协议格式说明  
	> 协议采用 proto3 格式编写,使用 protoc v3.0 beta2 编译

-	头结构:

> 该头结构将插入每个请求或返回的协议结构体中  
> 协议类名加前缀 "rq" 表示客户端->服务端,无前缀表示服务端->客户端

```protobuf
message Head {
    int64 idx = 1;  // 序号(必填)
    int32 ver = 2;  // 协议版本(必填,默认为协议发布日期6位整型)。当前版本为 160328
    string if_name = 3;  // 接口名称(可选)
    string unique = 5;  // 移动设备唯一标示(移动设备填充,可以由服务器配置文件设置是否校验)
    int64 if_dt = 100;  // 请求或返回时间(必填)
    int32 if_st = 101;  // 接口操作状态(返回必填)
                            // 1-操作成功, 0-操作失败, 原因参考msg, 10-用户未登录或超时(0.5h),请求被拒绝, 11-用户权限不足,12-用户登录ip非法,需重新登录
                            // 41-数据库连接失败,42-指令提交失败(socket pool),43-第三方接口调用失败,45-数据库提交失败,46-参数错误,
			    // 99-接口参数暂不支持
    string if_msg = 102;  // 失败时填充详细原因(可选)
    repeated string msg_filter = 103;  // 调用接口后可能产生的消息过滤器，仅对设备操作类型接口有效，如终端开关灯、选测，客户端可以动态设置这些过滤器用来获得精准推送
    int32 paging_num = 200;  // 此次请求/应答是否使用分页(仅对非参数数据查询类接口有效,'query'开头的接口),0-不使用,大于0时使用,但是,若客户端请求的赋值>100或数据总量大于100,服务端按照100进行强制分页
    int32 paging_idx = 201;  // 分页序号,从1开始,当序号大于分页总数时返回空
    int32 paging_total = 202;  // 服务端返回该次请求产生的分页总数(客户端请求数据时不填充)
    int64 paging_buffer_tag = 203;  // 分页缓存标签,0-要求服务器重建缓存,xx-根据服务器返回的tag从对应缓存读取数据
    int32 paging_record_total = 204;  // 查询记录总数
}
```

-	通用应答  
	> 通用应答仅包含head信息，用于不需要添加附加数据的场合

```
message CommAns {
    Head head = 1;  // 协议头信息
}
```

-	部分常用字段以及缩写说明

```
tml_id:     设备逻辑地址(系统分配,不可设置)
phy_id:     设备物理地址(硬件地址,可设置,高优先级,与tml_id同时存在时,将忽略tml_id)
rtu:        终端
slu:        单灯
ldu:        防盗
als:        光照度设备
esu:        节能设备
mru:        电表
sluitem:       单灯控制器
lduitem:       防盗末端
st:         状态
num:        数量
idx:        序号,索引号
msg:        详细信息
if:         接口
desc:       描述
pwd:        密码
rq:         请求
wsock:      websocket
ws:         webservice
grp:        组
argv:       参数
comm:       通信
hw:         硬件
adv:        进阶
```

---

### 2 基础信息类

#### 2.7 主设备基础信息返回

-	接口名称: tmlinfo  
	> 获取各类设备的基本参数以及工作参数  
	> 设备信息以模块为节点,与模块直接通信的设备均为主设备,下挂在模块下,通过终端485通信的设备或各类末端为附属设备,下挂在对应设备下 tml-泛指各类设备,rtu-路灯终端,als-光照度,slu-单灯,ldu-防盗,mru-抄表,esu-节能,com-模块

-	权限需求：

	-	需要用户具有读权限

-	参数:

	1.	uuid - 登录成功获得的动态id  
	2.	pb2 - 详细参数(结构如下)

```protobuf
message rqTmlInfo {
    Head head = 1;
    repeated int32 data_mark = 5 [packed=true];  // 请求数种类，可多选，1-baseinfo,2-gisinfo
    repeated int32 tml_id = 6 [packed=true];  // 请求的设备逻辑id, 留空-返回所有数据
}
```

-	返回:

```protobuf
message TmlInfo {
    message BaseInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        int32 phy_id = 2;  // 设备物理地址
        int32 tml_type = 3;  // 设备型号,1-终端,2-防盗,3-节能,4-抄表,5-光控,6-单灯,7-漏电
        int32 tml_st = 4;  // 设备状态,0-不用,1-停运,2-启用
        string tml_name = 5;  // 设备名称
        string tml_com_sn = 6;  // 设备模块序列号(可以为sim卡号,需要出厂设置)
        int32 tml_com_ip = 7;  // 模块ip地址(绑定ip时可设置,否则无意义)
        int32 tml_model = 8;  // 设备型号,3005,3006,2090,3090等
        int32 tml_parent_id = 9;  // 父设备id
        int64 tml_dt_setup = 10;  // 安装日期
        string tml_desc = 11;  // 备注
        int64 tml_dt_update = 12;  // 最后更新时间
        string tml_street = 13;  // 安装位置
        string tml_guid=14;  // 唯一识别号
    }
    message GisInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        double tml_pix_x = 5;  // 位图x坐标
        double tml_pix_y = 2;  // 位图y坐标
        double tml_gis_x = 3;  // gis x坐标
        double tml_gis_y = 4;  // gis y坐标
    }
    Head head = 1;
    repeated BaseInfo base_info = 12;  // 设备基础信息
    repeated GisInfo gis_info = 13;  // 设备地理信息
    repeated int32 data_mark = 3 [packed=true];  // 请求数种类,1-baseinfo,2-gisinfo
}
```

---

### 4. 数据查询类

#### 4.1 终端数据查询

-	接口名称: querydatartu  
	> 终端数据查询

-	权限需求：

	-	时钟召测需要用户具有读权限

-	参数:

	1.	uuid - 登录成功获得的动态id  
	2.	pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataRtu {
    Head head = 1;
    int64 dt_start = 5;  // 起始年月日时间,转换为long传输(1970-1-1开始的秒数)
    int64 dt_end = 6;  // 结束年月日时间,转换为long传输(1970-1-1开始的秒数)
    int32 type = 7;  // 类型,0-最新,1-历史
    repeated int32 tml_id = 9 [packed=true];  // 设备id,留空表示全部,可多选
}
```

-	返回:

```protobuf
message QueryDataRtu {
    message LoopView {
        double voltage = 1;  // 电压
        double current = 2;  // 电流
        double power = 3;  // 功率
        double rate = 4;  // 亮灯率
        double factor = 5;  // 功率因数
        int32 switch_in_st = 6;  // 开关量输入状态,0-断,1-通
        int32 voltage_over_range = 7;  // 电压越限,0-正常,1-越下线,2-越上限,3-越量程
        int32 current_over_range = 8;  // 电流越限,0-正常,1-越下线,2-越上限,3-越量程
    	string loop_name = 9;  // 回路名称
    	int32 loop_id = 10;  // 回路id
    }
    message DataRtuView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 14;  // 设备名称
        int64 dt_receive = 3;  // 数据接收时间
        repeated LoopView loop_view = 4;
        repeated int32 switch_out_st = 5 [packed=true];  // 开关量输出状态
        double current_sum_a = 6;  // A相总电流
        double current_sum_b = 7;  // B相总电流
        double current_sum_c = 8;  // C相总电流
        double voltage_a = 9;  // A相电压
        double voltage_b = 10;  // B相电压
        double voltage_c = 11;  // C相电压
        repeated int32 alarm_st = 12 [packed=true];  // 终端报警状态,共8位,每一位0-正常,1-异常,[供电,开机申请,停运,报警,电压超限,电流超限,无电流,参数错误]
        int32 temperature = 14; // 温度
    }
    Head head = 1;
    int32 type = 2;  // 类型,0-最新,1-历史
    repeated DataRtuView data_rtu_view = 3;
}
```

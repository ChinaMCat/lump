交互式综合服务接口设计说明
==========================

(The Description of Interactive Integrated Services Interface)

-	所有接口采用 HTTP 协议 post 方式请求, 地址格式为`http://ip:port/interface_name`  
-	提交的参数和返回数据格式为 Google Protocol Buffer ( protobuf ) 协议序列化后再经由 base64 编码得到的字符串  
-	所有请求以及返回中的时间字段均采用Linux时间戳格式,精确到秒,int64类型

-	protobuf 协议格式说明  
	> 协议采用 proto3 格式编写,使用 protoc v3.0 beta2 编译  
	> 所有时间字段，均采用Linux秒格式

-	头结构:

> 该头结构将插入每个请求或返回的协议结构体中  
> 协议类名加前缀 "rq" 表示客户端->服务端,无前缀表示服务端->客户端

```protobuf
message Head {
    int64 idx = 1;  // 序号(必填)
    int32 ver = 2;  // 协议版本(必填,默认为协议发布日期6位整型)。当前版本为 160328
    string if_name = 3;  // 接口名称(可选)
    int64 if_dt = 100;  // 请求或返回时间(必填)
    int32 if_st = 101;  // 接口操作状态(返回必填)
                            // 1-操作成功, 0-操作失败, 原因参考msg, 10-用户未登录或超时(0.5h),请求被拒绝, 11-用户权限不足,12-用户登录ip非法,需重新登录
                            // 41-数据库连接失败,42-指令提交失败(socket pool),43-第三方接口调用失败,45-数据库提交失败,46-参数错误,
			    // 99-接口参数暂不支持
    string if_msg = 102;  // 失败时填充详细原因(可选)
    repeated string msg_filter = 103;  // 调用接口后可能产生的消息过滤器，仅对设备操作类型接口有效，如终端开关灯、选测，客户端可以动态设置这些过滤器用来获得精准推送
    int32 paging_num = 200;  // 此次请求/应答是否使用分页(仅对非参数数据查询类接口有效,'query'开头的接口),0-不使用,大于0时使用,但是,若客户端请求的赋值>100或数据总量大于100,服务端按照100进行强制分页
    int32 paging_idx = 201;  // 分页序号,从1开始,当序号大于分页总数时返回空
    int32 paging_total = 202;  // 服务端返回该次请求产生的分页总数(客户端请求数据时不填充)
    int64 paging_buffer_tag = 203;  // 分页缓存标签,0-要求服务器重建缓存,xx-根据服务器返回的tag从对应缓存读取数据
    int32 paging_record_total = 204;  // 查询记录总数
}
```

-	通用应答  
	> 通用应答仅包含head信息，用于不需要添加附加数据的场合

```
message CommAns {
    Head head = 1;  // 协议头信息
}
```

---

### 监控终端类

#### 终端开关灯,停运/解除停运

> 接口名称: rtuctl  
> 向终端发送开关灯指令

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqRtuCtl {
    message RtuDo {
        int32 opt = 1;  // 1-单回路开关,2-多回路开关,3-停运,4-解除停运
        repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
        repeated int32 loop_do = 3 [packed=true];  // 从回路1开始最大16,要操作的内容0-关,1-开,2-不变,如3005共6个输出需要开启1,4,关闭2,6,则填入[1,0,2,1,2,0](opt=3,4时无效)
    }
    Head head = 1;
    repeated RtuDo rtu_do = 2;
}
```

返回:  
CommAns应答

---

#### 终端选测

> 接口名称: rtudataget  
> 终端选测

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqRtuDataGet {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
}
```

返回:  
CommAns应答

---

#### 终端版本信息获取

> 接口名称: rtuverget  
> 召测终端版本信息

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqRtuVerGet {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
}
```

返回:  
CommAns应答

---

#### 终端对时/召测时钟

> 接口名称: rtutimerctl  
> 终端对时/召测时钟

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqRtuTimerCtl {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
    int32 data_mark = 3;  // 0-设置时钟,1-召测时钟
}
```

返回:  
CommAns应答

---

#### 终端数据查询

> 接口名称: querydatartu  
> 终端数据查询

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataRtu {
    Head head = 1;
    int64 dt_start = 5;  // 起始年月日时间,转换为long传输(1970-1-1开始的秒数)
    int64 dt_end = 6;  // 结束年月日时间,转换为long传输(1970-1-1开始的秒数)
    int32 type = 7;  // 类型,0-最新,1-历史
    repeated int32 tml_id = 9 [packed=true];  // 设备id,留空表示全部,可多选
}
```

返回:

```protobuf
message QueryDataRtu {
    message LoopView {
        double voltage = 1;  // 电压
        double current = 2;  // 电流
        double power = 3;  // 功率
        double rate = 4;  // 亮灯率
        double factor = 5;  // 功率因数
        int32 switch_in_st = 6;  // 开关量输入状态,0-断,1-通
        int32 voltage_over_range = 7;  // 电压越限,0-正常,1-越下线,2-越上限,3-越量程
        int32 current_over_range = 8;  // 电流越限,0-正常,1-越下线,2-越上限,3-越量程
    	string loop_name = 9;  // 回路名称
    	int32 loop_id = 10;  // 回路id
    }
    message DataRtuView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 13;  // 设备名称
        int64 dt_receive = 3;  // 数据接收时间
        repeated LoopView loop_view = 4;
        repeated int32 switch_out_st = 5 [packed=true];  // 开关量输出状态
        double current_sum_a = 6;  // A相总电流
        double current_sum_b = 7;  // B相总电流
        double current_sum_c = 8;  // C相总电流
        double voltage_a = 9;  // A相电压
        double voltage_b = 10;  // B相电压
        double voltage_c = 11;  // C相电压
        repeated int32 alarm_st = 12 [packed=true];  // 终端报警状态,共8位,每一位0-正常,1-异常,[供电,开机申请,停运,报警,电压超限,电流超限,无电流,参数错误]
    }
    Head head = 1;
    int32 type = 2;  // 类型,0-最新,1-历史
    repeated DataRtuView data_rtu_view = 3;
}
```

---

### 单灯类

#### 单灯集中器选测

> 接口名称: sludataget  
> 单灯集中器选测

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqSluDataGet {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
    int32 data_mark = 3;  // 选测内容标示, 0-选测集中器状态,4-选测控制器物理信息,6-选测控制器辅助数据,7-选测控制器基本数据
    int32 sluitem_idx = 4;  // 控制器起始地址
    int32 sluitem_num = 5;  // 控制器数量
    int32 cmd_idx = 6;  // 命令序号
}
```

返回: CommAns应答

---

#### 单灯控制器选测

> 接口名称: sluitemdataget  
> 单灯控制器选测

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqSluitemDataGet {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
    int32 sluitem_idx = 3;  // 控制器地址
    Data_mark data_mark = 4;  // 选测标示
    int32 cmd_idx = 5;  // 命令序号
    message Data_mark {
        int32 read_data = 1;  // 选测
        int32 read_timer = 2;  // 读取时钟
        int32 read_args = 3;  // 读取运行参数
        int32 read_group = 4;  // 读取组地址
        int32 read_ver = 5;  // 读取版本
        int32 read_sunriseset = 6;  // 读取当天日出日落
        int32 read_timetable = 7;  // 读取本地参数（新）
        int32 read_ctrldata = 8;  // 读取控制器数据（新）
    }
}
```

返回: CommAns应答

---

#### 单灯控制

> 接口名称: sluctl  
> 单灯控制

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqSluCtl {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
    int32 cmd_idx = 3;  // 序号
    int32 operation_type = 4;  // 指令类型 0-清除，1-定时，2-经纬度，3-即时
    int32 operation_order = 5;  // 操作顺序 0-广播，1-依次
    int32 addr_type = 6;  //地址类型 0-全部，1-组，2-规则，3-单一，4-gprs
    repeated int32 addrs = 7 [packed=true];  // 控制器地址
    repeated int32 week_set = 8 [packed=true];  // 周设置
    int32 timer_or_offset = 9;  // 定时 hh*60+mm->int32 或偏移量 依据 operation_type定
    int32 cmd_type = 10;  // 操作类型 3-经纬度关灯，4-混合控制，5-pwm调节，6-485调节
    repeated int32 cmd_mix = 11 [packed=true];  // 混合回路操作 0-不操作，1-开灯，2-1档节能，3-2档节能，4-关灯（经纬度关灯时，cmd_type<4视为不操作）
    CmdPWM cmd_pwm = 12;  // pwm功率调节
    message CmdPWM {
        repeated int32 loop_can_do = 1 [packed=true];  // 回路(仅需要操作的回路序号)
        int32 scale = 2;  // 比例 0-100 -> 0%-100%
        int32 rate = 3;  // 频率 /100为发送值
    }
}
```

返回:  
CommAns应答

---

#### 单灯对时

> 接口名称: slutimerctl  
> 单灯时钟设置/召测

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqSluTimerCtl {
    Head head = 1;
    repeated int32 tml_id = 2 [packed=true];  // 要操作的设备逻辑地址列表,该列表中的终端均执行相同的操作
    int32 data_mark = 3; // 0-设置时钟,1-召测时钟
    int32 do_force = 4; // data_mark=0时有效,0-不强制对时,1-强制对时
}
```

返回:  
CommAns应答

---

#### 单灯集中器数据查询

> 接口名称: querydataslu  
> 单灯数据查询

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataSlu {
    Head head = 1;
    int64 dt_start = 5;  // 起始年月日时间,转换为long传输(1970-1-1开始的秒数)
    int64 dt_end = 6;  // 结束年月日时间,转换为long传输(1970-1-1开始的秒数)
    int32 type = 7;  // 类型,0-最新,1-历史, 当查询最新数据时,tml_id只支持单选,读取第一个值
    repeated int32 tml_id = 9 [packed=true];  // 设备id,留空表示全部,可多选
    int32 data_mark = 10;  // 数据类型标示,0-集中器状态数据,7-控制器数据,6-控制器辅助数据,4-控制器物理信息(暂无)
}
```

返回:

```protobuf
message QueryDataSlu {
    message DataSluView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 10;  // 设备名称
        int64 dt_receive = 3;  // 数据接收时间
        repeated int32 reset_times = 4 [packed=true];  // 连续4天复位次数,[今天,昨天,前天,大前天]
        repeated int32 st_running = 5 [packed=true];  // 集中器状态,[运行状态(0-正常,1-停运),报警状态(0-允许主报,1-禁止主报),开机申请(0-非开机申请,1-开机申请),通信方式(0-485,1-gprs),主动巡测(0-巡测,1-停止巡测)]
        repeated int32 st_argv = 6 [packed=true];  // 集中器参数状态,0-正常,1-出错,[集中器参数,控制器参数,开关灯参数]
        repeated int32 st_hw = 7 [packed=true];  // 硬件参数状态,0-正常,1-出错,[zigbee,电力载波,fram,蓝牙,硬件时钟]
        int32 unknow_sluitem_num = 8;  // 未知控制器数量
        repeated int32 zigbee_channel = 9 [packed=true];  // zigbee信道(1-16)
    }
    message DataSluitemView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 10;  // 设备名称
        int32 sluitem_id = 11;  // 控制器id
        string sluitem_name = 12;  // 控制器名称
        int64 dt_receive = 3;  // 数据接收时间
        int64 dt_cache = 5;  // 集中器缓存该条数据的时间
        repeated int32 st_sluitem = 6 [packed=true];  // 控制器状态,[继电器校准参数出错(0-正常,1-出错),EEPROM出错(0-正常,1-出错),停运(0-正常,1-停运),禁止主动报警(0-主动报警,1-禁止),设置工作参数(0-未设置,1-已设置),校准(0-未校准,1-已校准),状态(0-正常,1-电压越上限,2-电压越下限,3-通信故障)]
        int32 temperature = 7;  // 温度,255或0表示无测温模块
        repeated DataLampView data_lamp_view = 9;  // 灯头状态,数据
    }
    message DataLampView {
        int32 lamp_id = 8;  // 灯头id
        repeated int32 st_lamp = 1 [packed=true];  // 灯状态,[亮灯状态(0-亮灯,1-调档节能,2-调光节能,3-关灯),故障状态(0-正常,1-光源故障,2-补偿电容故障,3-意外灭灯,4-意外亮灯,5-自熄灯),漏电状态(0-无漏电,1-漏电),功率状态(0-正常,1-功率越上限,2-功率越下限)]
        double lamp_voltage = 2;  // 电压,单位V
        double lamp_current = 3;  // 电流,单位A
        double lamp_power = 4;  // 有功功率,单位W
        double lamp_electricity = 5;  // 累计电量,单位kW/h,0为无效数据
        double lamp_electricity_count = 9;  // 软件计算的累计电量,单位kW/h,0为无效数据
        double lamp_runtime = 6;  // 运行时间,单位分钟
        double lamp_runtime_count = 10;  // 软件计算的运行时间,单位分钟
        double lamp_saving = 7;  // 节能档位0-100%
    }
    message DataSluitemAssistView {
        message SluitemLampData {
            double max_voltage = 1;  // 最大电压
            double max_current = 2;  // 最大电流
            double electricity = 3;  // 累计电流
        }
        message SluitemAssistData {
            int32 sluitem_id = 3;  // 控制器id
            int64 dt_cache = 4;  // 数据缓存时间
            double leackage_current = 5;  // 漏电流
            repeated SluitemLampData sluitem_lamp_data = 6;  // 灯头数据
        }
        int32 tml_id = 1;
        int64 dt_receive = 2;  // 数据接收时间
        repeated SluitemAssistData slutiem_assist_data =3;
    }
    message DataSluitemPhyView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        int64 dt_receive = 3;  // 数据接收时间
        int32 sluitem_id = 4;  // 控制器地址
        int32 signal_strength = 5;  // 信号强度
        int32 routing = 6;  // 路由级数 电力载波 0-6,zigbee 0-10
        int32 phase = 7;  // 所在相位 0-无法确定，1-A，2-B，3-C
        int32 comm_success = 8;  // 通信成功次数 1-16
        int32 comm_all = 9;  // 通信总次数 1-16
        int32 sluitem_loops = 10;  // 控制器回路数量
        int32 power_saving = 11;  // 节能方式 0-无控制，1-只有开关灯，2-一档节能，3-二档节能，4-RS485，5-PWM
        int32 has_leakage = 12;  // 漏电流测量 0-无，1-有
        int32 has_temperature = 13;  // 温度采集 0-无，1-有
        int32 has_timer = 14;  // 时钟 0-无，1-有
        int32 model = 15;  // 型号 0-unknow,1-wj2090j
    }
    Head head = 1;
    int32 data_mark = 2;  // 数据类型标示,同请求
    repeated DataSluView data_slu_view = 3;  // 当data_mark=0时返回
    repeated DataSluitemView data_sluitem_view = 4; // 当data_mark=7时返回
    repeated DataSluitemAssistView data_sluitem_assist_view = 5;  // 当data_mark=6时返回
    repeated DataSluitemPhyView sluitem_phy_view = 6;  // 当data_mark=4时返回
}
```

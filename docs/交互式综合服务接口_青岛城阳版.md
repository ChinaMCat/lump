交互式综合服务接口设计说明
==========================

(The Description of Interactive Integrated Services Interface)

-	所有接口采用 HTTP 协议 post 方式请求, 地址格式为`http://<ip>:<port>/<interface name>`  
-	提交参数中的pb2以及返回数据格式为 Google Protocol Buffer ( protobuf ) 协议序列化后再经由 base64 编码得到的字符串

-	protobuf 协议格式说明  
	> 协议采用 proto3 格式编写,使用 protoc v3.0 beta2 编译  
	> 所有时间字段，均采用unix秒格式

-	头结构:

> 该头结构将插入每个请求或返回的协议结构体中  
> 协议类名加前缀 "rq" 表示客户端->服务端,无前缀表示服务端->客户端

```protobuf
message Head {
    int64 idx = 1;  // 序号(必填)
    int32 ver = 2;  // 协议版本(必填,默认为协议发布日期6位整型)。当前版本为 160328
    string if_name = 3;  // 接口名称(可选)
    int64 if_dt = 100;  // 请求或返回时间(必填)
    int32 if_st = 101;  // 接口操作状态(返回必填)
                            // 1-操作成功, 0-操作失败, 原因参考msg, 10-用户未登录或超时(0.5h),请求被拒绝, 11-用户权限不足,12-用户登录ip非法,需重新登录
                            // 41-数据库连接失败,42-指令提交失败(socket pool),43-第三方接口调用失败,45-数据库提交失败,46-参数错误,
			                // 99-接口参数暂不支持
    string if_msg = 102;  // 失败时填充详细原因(可选)
    repeated string msg_filter = 103;  // 调用接口后可能产生的消息过滤器，仅对设备操作类型接口有效，如终端开关灯、选测，客户端可以动态设置这些过滤器用来获得精准推送
    int32 paging_num = 200;  // 此次请求/应答是否使用分页(仅对非参数数据查询类接口有效,'query'开头的接口),0-不使用,大于0时使用,但是,若客户端请求的赋值>100或数据总量大于100,服务端按照100进行强制分页
    int32 paging_idx = 201;  // 分页序号,从1开始,当序号大于分页总数时默认返回最后页
    int32 paging_total = 202;  // 服务端返回该次请求产生的分页总数(客户端请求数据时不填充)
    int64 paging_buffer_tag = 203;  // 分页缓存标签,0-要求服务器重建缓存,xx-根据服务器返回的tag从对应缓存读取数据
    int32 paging_record_total = 204;  // 查询记录总数
}
```

-	公共应答  
	> 公共应答仅包含head信息，用于不需要添加附加数据的场合

```
message CommAns {
    Head head = 1;  // 协议头信息
}
```

-	部分常用字段以及缩写说明

```
tml_id:     设备逻辑地址(系统分配,不可设置)
phy_id:     设备物理地址(硬件地址,可设置,高优先级,与tml_id同时存在时,将忽略tml_id)
rtu:        终端
slu:        单灯
ldu:        防盗
als:        光照度设备
esu:        节能设备
mru:        电表
sluitem:       单灯控制器
lduitem:       防盗末端
st:         状态
num:        数量
idx:        序号,索引号
msg:        详细信息
if:         接口
desc:       描述
pwd:        密码
rq:         请求
wsock:      websocket
ws:         webservice
grp:        组
argv:       参数
comm:       通信
hw:         硬件
adv:        进阶
```

版本 v160328:
-------------

### 用户/区域类

> 所有用户均包含隐含属性:客户代码,即系统终端和服务器的通信端口号,当管理员创建新用户时,新用户自动继承该属性,所有操作也默认从uuid中获取该属性作为必要条件  
> 用户权限:  
> > 1-X(可操作)  
> > 2-W(可设置)  
> > 4-R(可查询)  
> > 3-XW(可操作,可设置)  
> > 5-RX(可查询,可操作)  
> > 6-RW(可设置,可查询)  
> > 7-RWX(可查询,可设置,可操作)  
> > 15-DRWX(管理员)

---

#### 用户验证

> 接口名称: userlogin (*post*)  
> 对登录用户的用户名和密码进行验证,验证成功返回uuid,有效期默认30分钟  
> 使用获得的uuid访问任意接口即可重置有效期  
> 若登录后ip发生变化,则认为是非法登录,会注销当前用户

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserLogin {
    Head head = 1;  // 协议头信息
    int32 dev = 2;  // 设备类型,1-pc,2-web,3-移动设备,不同设备同一用户可同时登录,同种设备同一用户互斥
    string unique = 3;  // 移动设备唯一标示(移动设备填充,可以由服务器配置文件设置是否校验)
    string user = 4;  // 用户名
    string pwd = 5;  // 密码
    double lon = 6; // 登录设备经度(选填)
    double lat = 7;  // 登录设备纬度(选填)
}
```

返回:

```protobuf
message UserLogin {
    Head head = 1;  // 协议头信息
    string uuid = 2;  // 用户验证成功后分配的uuid(系统生成)
    int32 auth = 3;  // 用户权限值
    string fullname = 4;  // 用户全名
    string user_db = 5;  // 用户关联数据库名称
    int32 user_area = 6;  // 用户的区域id(暂不用)
    string zmq = 7;  // 信息推送服务地址(zmp端口号)
    string remark = 8; // 备注信息,如工作流系统登录的返回信息
    repeated int32 area_r = 9 [packed=true];  // 可读区域
    repeated int32 area_w = 10 [packed=true];  // 可写区域
    repeated int32 area_x = 11 [packed=true];  // 可操作区域
}
```

---

#### 用户注销

> 接口名称: userlogout (*post*)  
> 用户退出登录,注销uuid

参数:  
1. uuid - 用户uuid

返回:  
CommAns应答

---

#### 用户uuid续订

> 接口名称: userrenew (*post*)  
> 用户续订当前uuid,续订后有效期为续订成功开始30分钟

参数:  
1. uuid - 用户当前uuid  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqUserRenew {
    Head head = 1;
    int32 dev = 2;  // 设备类型,1-pc,2-web,3-移动设备
    string unique = 3;  // 移动设备唯一标示(移动设备填充)
}
```

返回: CommAns应答

---

### 基础信息类

#### 系统基础信息(在线数量以及服务状态暂不支持)

> 接口名称: sysinfo (*post*)  
> 获取系统名称等信息

参数:  
1. uuid - 用户登录成功获得的uuid  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqSysInfo {
    Head head = 1;
    repeated int32 data_mark = 2[packed=true];  // 查询类型标记,1-系统名称,2-终端总数/启用数量/在线数量(暂不支持),
                                                                                    // 3-现存故障总数,终端现存故障总数,单灯现存故障总数,防盗现存故障总数,
                                                                                    // 4-系统包含的设备信息,
                                                                                    // 7-服务运行状态(暂不支持)
}
```

返回:

```protobuf
message SysInfo {
    Head head = 1;
    repeated int32 data_mark = 2[packed=true];  // 查询类型标记,同请求
    string sys_name = 3;  // 系统名称
    repeated int32 tml_num = 4 [packed=true];  // [终端总数,启用数量,在线数量(暂不支持)]
    repeated int32 err_num = 5 [packed=true];  // 故障总数 [现存故障总数,终端现存总数,单灯现存故障总数,防盗现存故障总数]
    repeated int32 st_svr = 6 [packed=true];  // [数据服务,通信服务],0-服务不在线,1-服务在线,2-服务状态未知(暂不支持)
    repeated int32 tml_type = 7 [packed=true];  // [终端数量,防盗数量,节能数量,抄表数量,光控数量,单灯数量,漏电数量]若无相应设备,则填0
}
```

---

### 设备信息类

> 设备信息以模块为节点,与模块直接通信的设备均为主设备,下挂在模块下,通过终端485通信的设备或各类末端为附属设备,下挂在对应设备下 tml-泛指各类设备,slu-单灯

#### 主设备基础信息返回

> 接口名称: tmlinfo (*post*)  
> 获取各类设备的基本参数以及工作参数

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqTmlInfo {
    Head head = 1;
    repeated int32 data_mark = 5 [packed=true];  // 请求数种类,1-baseinfo,2-gisinfo,3-updateinfo(仅填充baseinfo中的tml_id,tml_dt_update两个字段),11-slubaseinfo(单灯信息)
    repeated int32 tml_id = 6 [packed=true];  // 请求的设备逻辑id, 留空-返回所有数据
}
```

返回:

```protobuf
message TmlInfo {
    message BaseInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        int32 phy_id = 2;  // 设备物理地址
        int32 tml_type = 3;  // 设备型号,1-终端,2-防盗,3-节能,4-抄表,5-光控,6-单灯,7-漏电
        int32 tml_st = 4;  // 设备状态,0-不用,1-停运,2-启用
        string tml_name = 5;  // 设备名称
        string tml_com_sn = 6;  // 设备模块序列号(可以为sim卡号,需要出厂设置)
        int32 tml_com_ip = 7;  // 模块ip地址(绑定ip时可设置,否则无意义)
        int32 tml_model = 8;  // 设备型号,3005,3006,2090,3090等
        int32 tml_parent_id = 9;  // 父设备id
        int64 tml_dt_setup = 10;  // 安装日期
        string tml_desc = 11;  // 备注
        int64 tml_dt_update = 12;  // 最后更新时间
        string tml_street = 13;  // 安装位置
        string tml_guid=14;  // 唯一识别号
    }
    message GisInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        double tml_pix_x = 5;  // 位图x坐标
        double tml_pix_y = 2;  // 位图y坐标
        double tml_gis_x = 3;  // gis x坐标
        double tml_gis_y = 4;  // gis y坐标
    }
    message SluInfo {
        int64 tml_id = 1;  // 设备逻辑地址
        double slu_lon = 16;  // 经度
        double slu_lat = 17; // 纬度
        repeated SluItemInfo sluitem_info = 22;
    }
    message SluItemInfo {
        int64 sluitem_idx = 2;  // 条码
        int32 sluitem_loop_num = 11; // 回路数量
        string sluitem_name = 13;  // 名称
        int32 sluitem_id = 14;  // 地址,唯一,不可变
        int32 sluitem_phy_id = 15; // 物理地址,可变
        string sluitem_lamp_id = 16;  // 灯杆编号/名称
        double sluitem_gis_x = 17;  // x坐标
        double sluitem_gis_y = 18;  // y坐标
    }
    Head head = 1;
    repeated BaseInfo base_info = 12;  // 设备基础信息
    repeated GisInfo gis_info = 13;  // 设备地理信息
    repeated SluInfo slu_info = 16;  // 单灯设备填充
    repeated int32 data_mark = 3 [packed=true];  // 请求数种类,1-baseinfo,2-gisinfo,3-updateinfo(仅填充baseinfo中的tml_id,tml_dt_update两个字段),11-slubaseinfo(单灯信息)
}
```

---

### 数据查询类

#### 现存/历史故障查询

> 接口名称: querydataerr (*post*)  
> 现存/历史故障查询

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataErr {
    Head head = 1;
    int64 dt_start = 5;  // 起始年月日时间,转换为long传输(1970-1-1开始的秒数)
    int64 dt_end = 6;  // 结束年月日时间,转换为long传输(1970-1-1开始的秒数)
    int32 type = 7;  // 类型,0-现存,1-历史
    repeated int32 tml_id = 9 [packed=true];  // 设备id,留空表示全部,可多选
}
```

返回:

```protobuf
message QueryDataErr {
    message ErrView {
        int32 err_id = 1;  // 故障id
        string err_name = 2;  // 故障名称
        // int64 data_create_idx = 3;  // 产生故障的数据记录时间
        // int64 data_remove_idx = 4;  // 消除故障的数据记录时间
        int32 tml_id = 5;  // 产生故障的设备逻辑地址
        int64 dt_create = 6;  // 故障产生时间
        int64 dt_remove = 7;  // 故障消除时间(现存故障时为0)
        int32 phy_id = 8;  // 设备物理地址
        string tml_name = 9;  // 设备名称
        int32 tml_sub_id1 = 10;  // 回路序号 或控制系序号或线路序号
        int32 tml_sub_id2 = 11;  // 灯头序号 等
        string remark = 12;  // 备注
        int32 err_count = 13;  // 一定时间内的重复报警次数
    }
    Head head = 1;
    int32 type = 2;  // 类型,0-现存,1-历史
    repeated ErrView err_view = 3;
}
```

---

#### 单灯集中器数据查询

> 接口名称: querydataslu (*post*)  
> 单灯数据查询

参数:  
1. uuid - 登录成功获得的动态id  
2. pb2 - 详细参数(结构如下)

```protobuf
message rqQueryDataSlu {
    Head head = 1;
    int64 dt_start = 5;  // 起始年月日时间,转换为long传输(1970-1-1开始的秒数)
    int64 dt_end = 6;  // 结束年月日时间,转换为long传输(1970-1-1开始的秒数)
    int32 type = 7;  // 类型,0-最新,1-历史, 当查询最新数据时,tml_id只支持单选,读取第一个值
    repeated int32 tml_id = 9 [packed=true];  // 设备id,留空表示全部,可多选
    int32 data_mark = 10;  // 数据类型标示,0-集中器状态数据,7-控制器数据,6-控制器辅助数据(暂无),4-控制器物理信息(暂无)
}
```

返回:

```protobuf
message QueryDataSlu {
    message DataSluView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 10;  // 设备名称
        int64 dt_receive = 3;  // 数据接收时间
        repeated int32 reset_times = 4 [packed=true];  // 连续4天复位次数,[今天,昨天,前天,大前天]
        repeated int32 st_running = 5 [packed=true];  // 集中器状态,[运行状态(0-正常,1-停运),报警状态(0-允许主报,1-禁止主报),开机申请(0-非开机申请,1-开机申请),通信方式(0-485,1-gprs),主动巡测(0-巡测,1-停止巡测)]
        repeated int32 st_argv = 6 [packed=true];  // 集中器参数状态,0-正常,1-出错,[集中器参数,控制器参数,开关灯参数]
        repeated int32 st_hw = 7 [packed=true];  // 硬件参数状态,0-正常,1-出错,[zigbee,电力载波,fram,蓝牙,硬件时钟]
        int32 unknow_sluitem_num = 8;  // 未知控制器数量
        repeated int32 zigbee_channel = 9 [packed=true];  // zigbee信道(1-16)
    }
    message DataSluitemView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        string tml_name = 10;  // 设备名称
        int32 sluitem_id = 11;  // 控制器id
        string sluitem_name = 12;  // 控制器名称
        int64 dt_receive = 3;  // 数据接收时间
        int64 dt_cache = 5;  // 集中器缓存该条数据的时间
        repeated int32 st_sluitem = 6 [packed=true];  // 控制器状态,[继电器校准参数出错(0-正常,1-出错),EEPROM出错(0-正常,1-出错),停运(0-正常,1-停运),禁止主动报警(0-主动报警,1-禁止),设置工作参数(0-未设置,1-已设置),校准(0-未校准,1-已校准),状态(0-正常,1-电压越上限,2-电压越下限,3-通信故障)]
        int32 temperature = 7;  // 温度,255或0表示无测温模块
        repeated DataLampView data_lamp_view = 9;  // 灯头状态,数据
    }
    message DataLampView {
        int32 lamp_id = 8;  // 灯头id
        repeated int32 st_lamp = 1 [packed=true];  // 灯状态,[亮灯状态(0-亮灯,1-调档节能,2-调光节能,3-关灯),故障状态(0-正常,1-光源故障,2-补偿电容故障,3-意外灭灯,4-意外亮灯,5-自熄灯),漏电状态(0-无漏电,1-漏电),功率状态(0-正常,1-功率越上限,2-功率越下限)]
        double lamp_voltage = 2;  // 电压,单位V
        double lamp_current = 3;  // 电流,单位A
        double lamp_power = 4;  // 有功功率,单位W
        double lamp_electricity = 5;  // 累计电量,单位kW/h,0为无效数据
        double lamp_electricity_count = 9;  // 软件计算的累计电量,单位kW/h,0为无效数据
        double lamp_runtime = 6;  // 运行时间,单位分钟
        double lamp_runtime_count = 10;  // 软件计算的运行时间,单位分钟
        double lamp_saving = 7;  // 节能档位0-100%
    }
    message SluitemPhyView {
        int32 tml_id = 1;
        int32 phy_id = 2;
        int64 dt_receive = 3;  // 数据接收时间
        int32 sluitem_id = 4;  // 控制器地址
        int32 signal_strength = 5;  // 信号强度
        int32 routing = 6;  // 路由级数 电力载波 0-6,zigbee 0-10
        int32 phase = 7;  // 所在相位 0-无法确定，1-A，2-B，3-C
        int32 comm_success = 8;  // 通信成功次数 1-16
        int32 comm_all = 9;  // 通信总次数 1-16
        int32 sluitem_loops = 10;  // 控制器回路数量
        int32 power_saving = 11;  // 节能方式 0-无控制，1-只有开关灯，2-一档节能，3-二档节能，4-RS485，5-PWM
        int32 has_leakage = 12;  // 漏电流测量 0-无，1-有
        int32 has_temperature = 13;  // 温度采集 0-无，1-有
        int32 has_timer = 14;  // 时钟 0-无，1-有
        int32 model = 15;  // 型号 0-unknow,1-wj2090j
    }
    Head head = 1;
    int32 data_mark = 2;  // 数据类型标示,同请求
    repeated DataSluView data_slu_view = 3;  // 当data_mark=0时返回
    repeated DataSluitemView data_sluitem_view = 4; // 当data_mark=7时返回
    // repeated SluitemPhyView sluitem_phy_view = 5;  // 当data_mark=4时返回
}
```

---

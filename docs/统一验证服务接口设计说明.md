统一验证服务接口设计说明
========================

(Unified Authentication Service Interface Design Description)

|日期|修改人|修改内容|  
|:-:|:-:|:-|  
|徐源|2017-04-10|创建文档|  
|徐源|2017-04-19|修改部分数据库设计|

> 统一验证服务用于给集控中心，监控系统，移动平台，市政平台提供一个统一的用户验证服务，用户在该服务验证通过后，即可无缝登录各个平台，无须重复登录或切换用户

-	所有接口采用 HTTP 协议 post 方式请求, 地址格式为`http://ip:port/uas/interface_name`  
-	提交的参数和返回数据格式为 Google Protocol Buffer ( protobuf ) 协议序列化后再经由 base64 编码得到的字符串  
-	所有请求以及返回中的时间字段均采用Linux时间戳格式,精确到秒,int64类型  
-	用户密码在传输以及存储时均使用MD5不可逆加密

-	protobuf 协议格式说明  
	> 协议采用 proto3 格式编写,使用 protoc v3.0 beta2 编译  
	> 所有时间字段，均采用Linux秒格式

-	头结构:

> 该头结构将插入每个请求或返回的协议结构体中  
> 协议类名加前缀 "rq" 表示客户端->服务端,无前缀表示服务端->客户端

```protobuf
message Head {
    int64 idx = 1;  // 序号(必填), 默认0
    int32 ver = 2;  // 协议版本(必填,默认为协议发布日期6位整型)。当前版本为 160328
    string if_name = 3;  // 接口名称(可选)
    int64 if_dt = 100;  // 请求或返回时间(必填)
    int32 if_st = 101;  // 接口操作状态(返回必填)
                            // 1-操作成功, 0-操作失败, 原因参考msg, 10-用户未登录或超时(0.5h),请求被拒绝, 11-用户权限不足,12-用户登录ip非法,需重新登录
                            // 41-数据库连接失败,42-指令提交失败(socket pool),43-第三方接口调用失败,45-数据库提交失败,46-参数错误,
			                // 99-接口参数暂不支持
    string if_msg = 102;  // 失败时填充详细原因(可选)
}
```

-	通用应答  
	> 通用应答仅包含head信息，用于不需要添加附加数据的场合

```protobuf
message CommAns {
    Head head = 1;  // 协议头信息
}
```

-	数据库表结构如下：

	-	用户信息表(user_list)：  
		|序号|列名|类型|备注|  
		|:-:|:-|:-|:-|  
		|1|user_id|int(11) AUTO_INCREMENT|自增id|  
		|2|user_name|varchar(32)|用户登录名|  
		|3|user_pwd|char(32)|密码（32位md5码存储）|  
		|4|user_alias|varchar(32)|用户全名/昵称|  
		|5|user_mobile|int(8) UNSIGNED|用户手机号码|  
		|6|user_tel|varchar(30)|用户固定电话|  
		|7|user_email|varchar(50)|用户电子邮件地址|  
		|8|user_remark|text|备注|
	-	事件信息表(events_info)：  
		|序号|列名|类型|备注|  
		|:-:|:-|:-|:-|  
		|1|event_id|tinyint(3)|事件ID|  
		|2|event_name|varchar(50)|事件名称|  
		|3|event_remark|text|备注|
	-	事件日志表(events_log)：  
		|序号|列名|类型|备注|  
		|:-:|:-|:-|:-|  
		|1|events_log_id|int(11) AUTO_INCREMENT|自增id|  
		|2|event_id|tinyint(3)|事件ID|  
		|3|event_time|bigint(20)|事件发生时间|  
		|4|user_id|int(11)|产生事件的用户id|  
		|5|event_remark|text|备注|

-	数据库初始化脚本如下：

@import "uas.sql"

### 用户登录

> 接口名称: userlogin  
> 对登录用户的用户名和密码进行验证,验证成功返回用户id以及详细信息  
> - 流程如下：

```mermaid
    graph LR
        A(收到请求)-->B{判断用户名<br/>密码是否正确};
        B--是-->C(返回用户信息<br/>写入事件记录);
        C-->Z(结束);
        B--否-->D(返回错误信息<br/>写入事件记录);
        D-->Z;
```

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserLogin {
    Head head = 1;  // 协议头信息
    string user_name = 4;  // 用户名
    string user_pwd = 5;  // 密码
}
```

返回:

```protobuf
message UserLogin {
    Head head = 1;  // 协议头信息
    string fullname = 4;  // 用户全名
    int32 user_id = 12;  // 用户id
    int32 mobile = 13;  // 用户手机
    string tel = 14;  // 用户电话
    string email = 15; // 用户邮箱
    string remark = 16； // 备注
    string user = 17;  // 用户名
}
```

---

#### 添加用户

> 接口名称: useradd  
> 添加用户信息，一个系统添加的用户，在其他系统中第一次登录时需要在自身系统中补充该用户ID对应的相关权限信息后才可以正常使用

-	流程如下：  

```mermaid
    graph LR
        A(收到请求)-->B{判断提交参数<br/>是否合法};
        B--是-->C(写入用户信息<br/>写入事件记录);
        C-->D(返回新增用户ID);
        D-->Z(结束);
        B--否-->E(返回错误信息<br/>写入事件记录);
        E-->Z;
```

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserAdd {
    Head head = 1;
    string user = 2;  // 新用户登录名(用户登录名不可修改)
    string fullname = 3;  // 新用户全名
    string pwd = 4;  // 新用户密码
    int32 mobile = 7;  // 用户手机
    string tel = 14;  // 用户电话
    string email = 15; // 用户邮箱
    string remark = 16; // 备注
}
```

返回:

```protobuf
message UserLogin {
    Head head = 1;  // 协议头信息
    int32 user_id = 12;  // 用户id
}
```

---

#### 删除用户

> 接口名称: userdel  
> 删除用户, admin 帐号不允许删除

-	流程如下：  

```mermaid
    graph LR
        A(接收请求)-->B{判断是否<br/>Admin账户};
        B--是-->C{验证用户名<br/>密码是否一致};
        C--是-->E(删除用户信息<br/>添加事件记录);
        E-->Z(结束);
        B--否-->D(返回错误信息<br/>写入事件记录);
        C--否-->D;
        D-->Z;
```

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserDel {
    Head head = 1;
    string user = 2;  // 要删除的用户名
    string pwd = 3;  // 要删除的用户密码
}
```

返回: CommAns应答

---

#### 修改用户参数

> 接口名称: useredit  
> 修改用户参数，若修改密码，则下次登录时生效

-	流程如下：  
	![useredit](/docs/uas_edit.png)  

```mermaid
    graph LR
        A(接收请求)-->B{判断用户ID和<br/>用户名是否一致};
        B--是-->C(更新用户信息<br/>写入事件记录);
        C-->Z(结束);
        B--否-->D(返回错误信息<br/>写入事件记录);
        D-->Z;
```

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserEdit {
    Head head = 1;
    string user = 2;  // 要修改的用户id
    string fullname = 3;  // 新用户全名
    string pwd = 4;  // 新用户密码,如为空值表示不改密码
    string pwd_old = 9;  // 用户当前密码
    int32 mobile = 7;  // 用户手机
    string tel = 14;  // 用户电话
    string email = 15; // 用户邮箱
    string remark = 16; // 备注
}
```

返回: CommAns应答

---

#### 请求用户信息

> 接口名称: userinfo  
> 管理员查看用户信息

参数:  
1. pb2 - 详细参数(结构如下)

```protobuf
message rqUserInfo {
    Head head = 1;
    string user_name = 2;  // 要请求的用户名(留空-请求全部)
}
```

返回:

```protobuf
message UserInfo {
    message UserView {
        string user = 1;  // 用户登录名
        string fullname = 2;  // 用户全名
        int32 user_id = 7;  // 用户id
        string remark = 10;  // 备注
        int32 mobile = 11;  // 手机号
    }
    Head head = 1;
    repeated UserView user_view = 2;
}
```

---
